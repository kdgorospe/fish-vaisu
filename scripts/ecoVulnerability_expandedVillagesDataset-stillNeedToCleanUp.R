# Socio-Ecological Vulnerability Assessment

# Step 1 - Run munge code: 01_gitFishREACleanData_modifiedforSocioEcoVulnerability.R and 02_gitFishREACalcWD_modifiedforSocioEcoVulnerability.R
# Step 2 - Save output files from above under "~/Analyses/fish-outofwater/input


## OVERAL DATA AVAILABILITY FROM FISH TEAM: 
rm(list=ls())
library(reshape)  #cast function
library(ggplot2)
library(sp)
library(rgdal)
library(rgeos)
library(ggthemes)
library(ggmap)
library(RColorBrewer)

setwd("~/Analyses/fish-outofwater/input")
#load("TMPwsd_speciesLevelAbund-OLD.Rdata")
load("TMPwsd_speciesLevelAbund-TutuilaAndManuas.Rdata")

shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector.csv")

# MERGE fish data with site info (i.e., watershed assignment) data
#common.info<-names(wsd)[names(wsd) %in% names(shed.info)]
#Remove DATE, LAT, LONG
common.info<-c("SITEVISITID", "OBS_YEAR", "REGION", "SEC_NAME", "ISLAND", "SITE", "REEF_ZONE", "DEPTH_BIN")
shed.temp<-subset(shed.info, select=-c(DATE_, LATITUDE, LONGITUDE))
wsd.village<-merge(x=wsd, y=shed.temp, by=common.info, all.x=TRUE)
table(wsd.village$Watershed)

## CREATE: modify wsd (and save as .RData file) with "Manuas" and "Aunuu" as one of the watersheds

# First identify Manua sites in wsd.village, later (below, after cleaning up / adding all new watershed data) save as .RData file
manua.sites<-wsd.village$SITE[wsd.village$ISLAND %in% c("Tau", "Ofu & Olosega")]

levels(wsd.village$Watershed)<-c(levels(wsd.village$Watershed), "Manuas")
wsd.village$Watershed[wsd.village$SITE %in% manua.sites]<-"Manuas"
table(wsd.village$Watershed)



###################################################
# Identify Aunuu sites: See Alice's email from 02-26-18 (only include NW and SW parts of island) - 
# (1) exclude all SEC_NAME==AUNUU_SANCTUARY_B 
# (2) for all sites with Watershed==Outerbank and SEC_NAME==TUT_NE, exclude: (i) all the northern bank points, (ii) six eastern most points and (iii) one southern most point (see Tomoko's map)
# PLOT shed.info and manually select sites for "AUNUU WATERSHED"
# Get base map
colors <- brewer.pal(9, "BuGn")
mapCenter<-geocode("-14.294665, -170.698844") # LAT/LONG of central TUTUILA taken from GoogleMaps
asMap<-get_map(c(lon=mapCenter$lon, lat=mapCenter$lat), zoom=11, maptype="terrain", source="google")

# (i) Figure out which northern points should be excluded
wsd.map<-wsd.village


wsd.map<-wsd.map[wsd.map$Watershed=="Outer Banks",]
wsd.map<-wsd.map[wsd.map$SEC_NAME=="TUT_NE",]
wsd.map<-wsd.map[order(wsd.map$LATITUDE, decreasing=TRUE),]
wsd.map$SITE 
wsd.map<-wsd.map[1:8,] 
# TRIAL and ERROR - plotting map (below) confirms that the 8 northern most points do not belong to AUNUU; if you change index to [1:9,] we get first Aunuu site
# ie - remaining POTENTIAL AUNUU SITES INCLUDE:
#TUT-00356 TUT-00212 TUT-00066 TUT-00218 TUT-00552 TUT-00560
#TUT-00016 TUT-01035 TUT-00324 TUT-00321 TUT-01111 TUT-00531


# Combine map + data:
sectorMap<-ggmap(asMap)+
  geom_point(data=wsd.map, aes(x = LONGITUDE, y = LATITUDE, color=SEC_NAME), size=0.8)+
  labs(x="Longitude", y="Latitude")+
  theme(legend.position = "bottom")


setwd("~/Analyses/_RESULTS/fish-outofwater")
mapfilename<-paste("amSamMap.pdf", sep="")
pdf(file=mapfilename)
print(sectorMap)
dev.off()

# (ii) Figure out which of the eastern-most points should be excluded
wsd.map<-wsd.village

wsd.map<-wsd.map[wsd.map$Watershed=="Outer Banks",]
wsd.map<-wsd.map[wsd.map$SEC_NAME=="TUT_NE",]
wsd.map<-wsd.map[order(wsd.map$LONGITUDE, decreasing=TRUE),]
wsd.map$SITE 
wsd.map<-wsd.map[1:6,]
# TRIAL and ERROR - plotting map (below) confirms that the 6 eastern most points do not belong to AUNUU; if you change index to [1:7,] we get first Aunuu site
# ie - remaining POTENTIAL AUNUU SITES INCLUDE:
#TUT-00356 TUT-00212 TUT-00531 TUT-00066 TUT-00218 
#TUT-00552 TUT-00560 TUT-00016 TUT-00568 TUT-00597 
#TUT-00583 TUT-00326 TUT-00228 TUT-01228

# Combine map + data:
sectorMap<-ggmap(asMap)+
  geom_point(data=wsd.map, aes(x = LONGITUDE, y = LATITUDE, color=SEC_NAME), size=0.8)+
  labs(x="Longitude", y="Latitude")+
  theme(legend.position = "bottom")


setwd("~/Analyses/_RESULTS/fish-outofwater")
mapfilename<-paste("amSamMap.pdf", sep="")
pdf(file=mapfilename)
print(sectorMap)
dev.off()

# (iii) Figure out which is the southern most point and exclude this point
wsd.map<-wsd.village
wsd.map<-wsd.map[wsd.map$Watershed=="Outer Banks",]
wsd.map<-wsd.map[wsd.map$SEC_NAME=="TUT_NE",]
wsd.map<-wsd.map[order(wsd.map$LATITUDE, decreasing=TRUE),]
wsd.map$SITE
# ie - exclude TUT-00531

# CONCLUSION: AUNUU sites are those sites that are common between the two potential listings above, minus TUT=00531:
# TUT-00356, TUT-00212, TUT-00066, TUT-00218, TUT-00552, TUT-00560, TUT-00016 
# list of AUNUU SITES from above:
aunuu<-c("TUT-00356", "TUT-00212", "TUT-00066", "TUT-00218", "TUT-00552", "TUT-00560", "TUT-00016")
wsd.map<-wsd.village
wsd.map<-wsd.map[wsd.map$SITE %in% aunuu,]

sectorMap<-ggmap(asMap)+
  geom_point(data=wsd.map, aes(x = LONGITUDE, y = LATITUDE, color=SEC_NAME), size=0.8)+
  labs(x="Longitude", y="Latitude")+
  theme(legend.position = "bottom")


setwd("~/Analyses/_RESULTS/fish-outofwater")
mapfilename<-paste("amSamMap.pdf", sep="")
pdf(file=mapfilename)
print(sectorMap)
dev.off()


# CREATE NEW WATERSHED LABEL FOR ALL AUNUU SITES

levels(wsd.village$Watershed)<-c(levels(wsd.village$Watershed), "Aunuu")
wsd.village$Watershed[wsd.village$SITE %in% aunuu]<-"Aunuu"

table(wsd.village$Watershed)

setwd("~/Analyses/fish-outofwater/input")
save(wsd.village, file="TMPwsd_speciesLevelAbund-AnalysisReady.Rdata")




########################################################################
########################################################################
########################################################################
########################################################################

# I. Ecological Exposure: Cinner uses a previously published spatial model of
# susceptibility to bleaching-induced mortality
# Options: (1) Possible to use Maynard's exposure index here?
# (2) NOAA CORIS and UNEP: 4m grid of temeprature exposure
# Talk to Tom about this

# II. Ecological Sensitivity has two components: 
# (1) Coral bleaching susceptibility and 
# (2) Reef fish susceptibility to coral decline

# For Coral bleaching susceptibility, ask Dione for:
# (a) Relative abundance of each coral taxon (Genus?): Village-level
# (b) Taxon-specific bleaching response to a recent bleaching event: Island or regional-level
# Also, will need benthic team data for some of the Recovery Potential indicators
# Namely (see section below), Coral Size Distribution , and Coral Richness

# CALCULATE coral bleaching susceptibility
rm(list=ls())
setwd("~/Analyses/socio-ecoVulnerability/input/")
faga.a<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgenabd_estKG-Fagaa-abundance.csv")
faga.b<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgenabd_estKG-Fagaa-bleaching.csv")
vatia.a<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgenabd_estKG-Vatia-abundance.csv")
vatia.b<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgenabd_estKG-Vatia-bleaching.csv")

# Bleaching times abundance per genera:
# NOTES on spreadsheets - "abd" column are the TOTALS, whether total "abundance" (faga.a) or total "bleaching" (faga.b)
# "wavdns" stands for weighted average density (i.e., g/m2), whether density of "abundance" (faga.a) or bleaching (faga.b)

# Below is: fagaalu bleaching density column x fagaalu abundance density column
faga.b$suscept<-faga.b$wavdns * faga.a$wavdns
# faga.b$suscept is bleaching susceptibility per genera
# sum column to get suceptibility for the whole bay:
sum(faga.b$suscept) #0.02796969

# Now, Vatia
vatia.b$suscept<-vatia.b$wavdns * vatia.a$wavdns
sum(vatia.b$suscept) #0.1050131

##############################################################################
##############################################################################
##############################################################################
##############################################################################
###### THIS SECTION: (1) FISH BLEAHCING SUSCEPTIBILITY and (2) FISH SPECIES RICHNESS

# For Fish bleaching susceptibility, calculate:
# (1) Relative abundance of each fish taxon (Species?)
# (2) Taxon-specific vulnerability index: (a) Use CRED SPC data around Tutuila to evaluate 
# species-level response to live coral cover? or (b) Arielle saw a talk by JONATHA GIDDENS at ICRS
# presenting an index of species-level coral bleaching susceptibility based on lit review

# STEP 1 - merge site-level species abundance data with Jonatha's climate change susceptbility index
# (a) Identify which species are missing the index
# (b) Create a table using CRED's Lmax and Trophic Classification data to make our own climate change susceptibility index

rm(list=ls())
library(reshape)  #cast function

setwd("~/Analyses_notGit/socio-ecoVulnerability/input")
load("TMPwsd_speciesLevelAbund.Rdata")





#load("~/Analyses/socio-ecoVulnerability/TMPwsd_SITELevelFromAdel.RData") # Not sure why - Adel's site level data is different from mine?
ccdat<-read.csv("Hawaii_Fish_susceptibility_index_Giddens.csv")

fishcols<-subset(wsd, select=ABSO:ZEVE)
species<-names(fishcols)
sitecols<-subset(wsd, select=SITEVISITID:DEPTH)
siteinfo<-names(sitecols)

wsd.tmp<-subset(wsd, select=c(SITEVISITID:DEPTH, ABSO:ZEVE))
wsd.tmp[wsd.tmp==0]<-"NA"
#if I try to force NA's initially, melt won't remove these rows because it cannot be coerced as a logical value (columns are numeric)
# so instead melt first and remove NAs below
wsd.melt<-melt(wsd.tmp, id.vars=siteinfo, na.rm=TRUE)

names(wsd.melt)[(length(wsd.melt)-1):length(wsd.melt)]<-c("SPECIES", "abundance")

# Now remove NA's
na.fish<-wsd.melt$abundance!="NA"
wsd.melt<-wsd.melt[na.fish,]


# Merge with Jonatha's climate change suscept data
ccdat.short<-subset(ccdat, select=c("SpeciesCode", "Climate_susceptibility"))
names(ccdat.short)[names(ccdat.short)=="SpeciesCode"]<-"SPECIES"
wsd.cc<-merge(x=wsd.melt, y=ccdat.short, by="SPECIES", all.x=TRUE)

# Merge with Tomoko's watershed (WITH AUNUU) ID file - Assign sites to watershed
shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector_withAunuu.csv")

common.info<-names(wsd.cc)[names(wsd.cc) %in% names(shed.info)]
#Remove DATE, LAT, and LONG
common.info<-c("OBS_YEAR", "REGION", "ISLAND", "SEC_NAME", "SITE", "REEF_ZONE", "DEPTH_BIN")
wsd.village<-merge(x=wsd.cc, y=shed.info, by=common.info, all.x=TRUE)
wsd.village<-subset(wsd.village, select=c(OBS_YEAR:Climate_susceptibility,Watershed))


#Which ones are NAs??
#shed.info[shed.info$SITE=="TUT-00510",]$LATITUDE==wsd.village[8477,]$LATITUDE
#tmp.test<-is.na(wsd.village$Watershed)
#village.test<-wsd.village[tmp.test,]
#na.village<-unique(village.test$SITE)
#na.village<-as.data.frame(na.village)
#write.table(na.village, file="na.villages.txt", quote=FALSE)

# old wsd.test<-(wsd.village$Watershed=="Vatia" | wsd.village$Watershed=="Faga'alu")
#wsd.study<-wsd.village[wsd.test,] # Originally was subsetting wsd to only include Vatia and Fagaalu

wsd.study<-wsd.village

# HOW MANY SITES:
length(unique(wsd.study$SITE)) #80

# Which fish have missing climate data?
na.climate<-is.na(wsd.study$Climate_susceptibility)
na.climate.fish<-wsd.study$SPECIES[na.climate]
na.climate.fish<-unique(na.climate.fish)
length(unique(na.climate.fish)) # How many fish with no climate data? 302
length(unique(wsd.study$SPECIES)) # out of total of 431 fish (i.e., ~130 have good climate susceptibility info from Jonatha's list)
# The rest we'll have to fill in using our species table

# Join with FISH SPECIES LIST to get full scientific names
fish.tab<-read.csv("LIST_OF_FISH_SPECIES 20161024.csv")
# Jonatha's index requires max body size (< or > 20cm) and trophic group (corallivore, mixed, or herbivore)
fish.names<-subset(fish.tab, select=c("SPECIES", "SCIENTIFIC_NAME", "TAXONNAME", "LMAX", "TROPHIC"))

noclimate.test<-fish.names$SPECIES %in% na.climate.fish
noclimate.df<-as.data.frame(fish.names$SPECIES[noclimate.test])
names(noclimate.df)<-"SPECIES"
final.list<-merge(x=noclimate.df, y=fish.names, by="SPECIES")

final.list<-cbind(final.list, final.list$LMAX<20) # if TRUE, then yes, susceptible to coral loss
names(final.list)[length(final.list)]<-"SIZESUSCEPT"

final.list$TROPHSUSCEPT<-NA
final.list$TROPHSUSCEPT[final.list$TROPHIC=="Cor"]<-2
final.list$TROPHSUSCEPT[final.list$TROPHIC=="H"]<-0
final.list$TROPHSUSCEPT[final.list$TROPHIC!="H" & final.list$TROPHIC!="Cor"]<-1

final.list$SUSCEPTCODE<-NA
final.list$SUSCEPTCODE<-paste(final.list$TROPHSUSCEPT, final.list$SIZESUSCEPT, sep="")

final.list$Climate_susceptibility<-NA
final.list$Climate_susceptibility[final.list$SUSCEPTCODE=="0FALSE"]<-"Negligible" # Negligible
final.list$Climate_susceptibility[final.list$SUSCEPTCODE=="1FALSE"]<-"Very low" # Very low
final.list$Climate_susceptibility[final.list$SUSCEPTCODE=="2FALSE"]<-"Low" # Low
final.list$Climate_susceptibility[final.list$SUSCEPTCODE=="0TRUE"]<-"Medium" # Medium
final.list$Climate_susceptibility[final.list$SUSCEPTCODE=="1TRUE"]<-"High" # High
final.list$Climate_susceptibility[final.list$SUSCEPTCODE=="2TRUE"]<-"Very high" # Very high

# SAVE Table
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.table(final.list, file="AmSamFish_MissingClimateData.txt", quote=FALSE )

# NEXT STEP IS TO TAKE "final.list" which now has the filled in Climate_susceptibility category
# And use this to fill in missing data in wsd.study
final.short<-subset(final.list, select=c(SPECIES, Climate_susceptibility))
sum(final.short$SPECIES %in% ccdat.short$SPECIES) # check that there are no duplicate species
final.ccdat<-rbind(final.short, ccdat.short)

# STEP 2 - TAKE "final.ccdat" which now has the filled in Climate_susceptibility category
# And use this to fill in missing data in wsd.study
# Probably easiest to start over: Add new info to Jonatha's table (ccdat.short) and go back to wsd and merge

fishcols<-subset(wsd, select=ABSO:ZEVE)
species<-names(fishcols)
sitecols<-subset(wsd, select=SITEVISITID:DEPTH)
siteinfo<-names(sitecols)

wsd.tmp<-subset(wsd, select=c(SITEVISITID:DEPTH, ABSO:ZEVE))
#wsd.tmp[wsd.tmp==0]<-"NA"
#if I try to force NA's initially, melt won't remove these rows because it cannot be coerced as a logical value (columns are numeric)
# so instead melt first and remove NAs below
wsd.melt<-melt(wsd.tmp, id.vars=siteinfo, na.rm=TRUE)

names(wsd.melt)[(length(wsd.melt)-1):length(wsd.melt)]<-c("SPECIES", "abundance")

# Now remove 0's
na.fish<-wsd.melt$abundance!="0"
wsd.melt<-wsd.melt[na.fish,]

################################################################
################################################################
################################################################
# Merge with COMPLETE (I.E., final.ccdat) climate change suscept data
wsd.cc<-merge(x=wsd.melt, y=final.ccdat, by="SPECIES", all.x=TRUE)

# Merge with Tomoko's watershed ID file - Assign sites to watershed
setwd("~/Analyses_notGit/socio-ecoVulnerability/input")
shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector_withAunuu.csv")
#common.info<-names(wsd.cc)[names(wsd.cc) %in% names(shed.info)]
#Remove DATE, LAT, and LONG
common.info<-c("OBS_YEAR", "REGION", "ISLAND", "SEC_NAME", "SITE", "REEF_ZONE", "DEPTH_BIN")
wsd.village<-merge(x=wsd.cc, y=shed.info, by=common.info, all.x=TRUE)
wsd.village<-subset(wsd.village, select=c(OBS_YEAR:Climate_susceptibility, ANALYSIS_SCHEME, Watershed)) 
#names(wsd.village)[21]<-"ANALYSIS_SCHEME"


#Which ones are NAs??
#shed.info[shed.info$SITE=="TUT-00510",]$LATITUDE==wsd.village[8477,]$LATITUDE
#tmp.test<-is.na(wsd.village$Watershed)
#village.test<-wsd.village[tmp.test,]
#na.village<-unique(village.test$SITE)
#na.village<-as.data.frame(na.village)
#write.table(na.village, file="na.villages.txt", quote=FALSE)

#wsd.test<-(wsd.village$Watershed=="Vatia" | wsd.village$Watershed=="Faga'alu")
#wsd.study<-wsd.village[wsd.test,]

wsd.study<-wsd.village

# HOW MANY SITES:
length(unique(wsd.study$SITE)) #80

# CREATE PRESENCE LSIT FOR THE TWO WATERSHED FOR ARIELLE:
wsd.faga<-wsd.study[wsd.study$Watershed=="Faga'alu",]
pres.faga<-unique(wsd.faga[,c("SPECIES", "Climate_susceptibility")]) #174
#fish.faga<-fish.names$SPECIES %in% pres.faga$SPECIES
#faga.df<-as.data.frame(fish.names$SPECIES[fish.faga])
#names(faga.df)<-"SPECIES"
faga.list<-merge(x=pres.faga, y=fish.names, by="SPECIES")

setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(faga.list, file="FishSpeciesList_Fagaalu.csv", quote=FALSE, row.names=FALSE)

wsd.vat<-wsd.study[wsd.study$Watershed=="Vatia",]
pres.vat<-unique(wsd.vat[,c("SPECIES", "Climate_susceptibility")]) #279
#fish.vat<-fish.names$SPECIES %in% pres.vat
#vat.df<-as.data.frame(fish.names$SPECIES[fish.vat])
#names(vat.df)<-"SPECIES"
vat.list<-merge(x=pres.vat, y=fish.names, by="SPECIES")

setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(vat.list, file="FishSpeciesList_Vatia.csv", quote=FALSE, row.names=FALSE)

# SITE-LEVEL FISH SUSCEPTIBILITY TO BLEACHING: 


wsd.study$ClimateIndex<-NA
wsd.study$ClimateIndex[wsd.study$Climate_susceptibility=="Very high"]<-5
wsd.study$ClimateIndex[wsd.study$Climate_susceptibility=="High"]<-4
wsd.study$ClimateIndex[wsd.study$Climate_susceptibility=="Medium"]<-3
wsd.study$ClimateIndex[wsd.study$Climate_susceptibility=="Low"]<-2
wsd.study$ClimateIndex[wsd.study$Climate_susceptibility=="Very low"]<-1
wsd.study$ClimateIndex[wsd.study$Climate_susceptibility=="Negligible"]<-0

# FIRST NEED RELATIVE ABUNDANCE i.e., abundance for species i / total abundance of all species at site
abundSite<-aggregate(wsd.study$abundance, by=list(wsd.study$SITE), FUN=sum)
names(abundSite)<-c("SITE", "totalAbundance")
wsd.wAbund<-merge(wsd.study, abundSite, by="SITE", all=TRUE)
wsd.wAbund$relatAbundance<-NA
wsd.wAbund$relatAbundance<-wsd.wAbund$abundance/wsd.wAbund$totalAbundance

## RELATIVE abundance x climate susceptibility, summed across species per site
wsd.wAbund$fishSuscept<-NA
wsd.wAbund$fishSuscept<-wsd.wAbund$relatAbundance*wsd.wAbund$ClimateIndex

#common.cols<-c("SITE", "OBS_YEAR", "REGION", "ISLAND", "REEF_ZONE", "DEPTH_BIN", "SITEVISITID", "METHOD", "REGION_NAME", 
#               "ANALYSIS_SEC", "ANALYSIS_YEAR", "ANALYSIS_STRATA", "DATE_.x", "LATITUDE.x", "LONGITUDE.x", "DEPTH", "Watershed")
#siteSuscept<-aggregate(wsd.wAbund$fishSuscept, by=list(common.cols), FUN=sum)
siteSuscept<-aggregate(fishSuscept ~ SITE + OBS_YEAR + REGION + ISLAND + REEF_ZONE + DEPTH_BIN + SITEVISITID.x + METHOD + REGION_NAME + 
                       ANALYSIS_SEC + ANALYSIS_YEAR + ANALYSIS_STRATA + DATE_.x + LATITUDE.x + LONGITUDE.x + DEPTH + ANALYSIS_SCHEME + Watershed,
                       data=wsd.wAbund, FUN=sum)

siteRichness<-aggregate(SPECIES ~ SITE + OBS_YEAR + REGION + ISLAND + REEF_ZONE + DEPTH_BIN + SITEVISITID.x + METHOD + REGION_NAME + 
                          ANALYSIS_SEC + ANALYSIS_YEAR + ANALYSIS_STRATA + DATE_.x + LATITUDE.x + LONGITUDE.x + DEPTH + ANALYSIS_SCHEME + Watershed,
                        data=wsd.wAbund, FUN=length)
names(siteRichness)[length(names(siteRichness))]<-"RICHNESS"

# ADD STRATA COLUMN for POOLING
#siteSuscept$STRATA<-paste(siteSuscept$REEF_ZONE, siteSuscept$DEPTH_BIN, sep='')


#names(siteSuscept)<-c("SITE", "siteSuscept")
#setwd("~/Analyses/socio-ecoVulnerability/input")
#shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector.csv")
#common.info<-c("OBS_YEAR", "REGION", "ISLAND", "SEC_NAME", "SITE", "REEF_ZONE", "DEPTH_BIN")
#finalSuscept<-merge(x=siteSuscept, y=shed.info, by="SITE")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(siteSuscept, file="siteLevelCCSuscept.csv", quote=FALSE, row.names=FALSE)
write.csv(siteRichness, file="siteLevelSpeciesRichness.csv", quote=FALSE, row.names=FALSE)

# DON'T HAVE STRATA AREAS FOR EACH WATERSHED
# instead of calculating "design estimates", can only calculate watershed-level means
shed.fishSuscept<-aggregate(x=siteSuscept$fishSuscept, by=list(siteSuscept$Watershed), FUN=mean)
names(shed.fishSuscept)<-c("Watershed", "fishSuscept")
write.csv(shed.fishSuscept, "indexFishBleachingSusceptibility-AllWatersheds.csv")

shed.Richness<-aggregate(x=siteRichness$RICHNESS, by=list(siteSuscept$Watershed), FUN=mean)
names(shed.Richness)<-c("Watershed", "RICHNESS")
write.csv(shed.Richness, "indexSpeciesRichness-AllWatersheds.csv")


##############################################################################
##############################################################################
##############################################################################
##############################################################################
##############################################################################
##############################################################################
##############################################################################
##############################################################################
# III. Ecological recovery potential: Weighted metric of 10 ecological indicators

# Calculate Coral size distribution metric:
# Estimated as the coefficient of variation (CV, mean size / standard deviation of size) of the average size of each coral genus
# Here, I have this per genera: take the CV for each genera, weight each one by the genera's abundance, and sum across genera
rm(list=ls())
setwd("~/Analyses/socio-ecoVulnerability/input/")

# meansize data
# NOTE: wavsz = weighted mean size; se_wsz = weighted standard error of mean size; wcv_sz = cv of weighted mean size
faga.ms<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgen_mnszestKG-FAGAALU.csv")
vatia.ms<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgen_mnszestKG-VATIA.csv")
names(faga.ms)[1]<-"genera"
names(vatia.ms)[1]<-"genera"

# abundance
faga.a<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgenabd_estKG-Fagaa-abundance.csv")
vatia.a<-read.csv("BenthicTeamData/samoa2015LBSP_adcorgenabd_estKG-Vatia-abundance.csv")
names(faga.a)[1]<-"genera"
names(vatia.a)[1]<-"genera"

# merge by genera
faga.all<-merge(faga.ms, faga.a, by="genera")
vatia.all<-merge(vatia.ms, vatia.a, by="genera")

# multiply wcv_sz (i.e., CV) X wavdns (i.e., abundance)
faga.all$metricByGenera <- faga.all$wcv_sz * faga.all$wavdns
# Sum across genera to get watershed-level:
sum(faga.all$metricByGenera, na.rm=TRUE) #120.3479

vatia.all$metricByGenera <- vatia.all$wcv_sz * vatia.all$wavdns
sum(vatia.all$metricByGenera, na.rm=TRUE) #q


##############################################################################
##############################################################################
##############################################################################
##############################################################################
##############################################################################
# CALCULATE watershed-level benthic covers and complexity
rm(list=ls())


setwd("~/Analyses_notGit/socio-ecoVulnerability/input")
# First need to create wsd for families (e.g., )
load("TMPwsd_speciesLevelAbund_withAunuu.RData")


### HARD CORAL COVER:
wsd<-wsd.village # RESET
wsd.study<-wsd[!is.na(wsd$HARD_CORAL),]
coral.shed<-aggregate(wsd.study$HARD_CORAL, by=list(wsd.study$Watershed), FUN=mean)
names(coral.shed)<-c("Watershed", "Coral Cover")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(coral.shed, "indexCoralCover-AllWatersheds.csv")

### CCA
wsd<-wsd.village
wsd.study<-wsd[!is.na(wsd$CCA),]
cca.shed<-aggregate(wsd.study$CCA, by=list(wsd.study$Watershed), FUN=mean)
names(cca.shed)<-c("Watershed", "CCA Cover")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(cca.shed, "indexCCACover-AllWatersheds.csv")

### MACROALGA COVER
wsd<-wsd.village
wsd.study<-wsd[!is.na(wsd$MA),]
ma.shed<-aggregate(wsd.study$MA, by=list(wsd.study$Watershed), FUN=mean)
names(ma.shed)<-c("Watershed", "MA Cover")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(ma.shed, "indexMACover-AllWatersheds.csv")

### TURF COVER
wsd<-wsd.village
wsd.study<-wsd[!is.na(wsd$TA),]
turf.shed<-aggregate(wsd.study$TA, by=list(wsd.study$Watershed), FUN=mean)
names(turf.shed)<-c("Watershed", "Turf Cover")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(turf.shed, "indexTurfCover-AllWatersheds.csv")


### COMPLEXITY
wsd.study<-wsd[!is.na(wsd$MEAN_SH),]
complex.shed<-aggregate(wsd.study$MEAN_SH, by=list(wsd.study$Watershed), FUN=mean)
n.shed<-as.data.frame(table(wsd.study$Watershed))
names(n.shed)<-c("Watershed", "N")
names(complex.shed)<-c("Watershed", "Complexity")
complex.index<-merge(n.shed, complex.shed, by="Watershed")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(complex.index, "indexComplexity-AllWatersheds.csv")

##############################################################################
##############################################################################
## CALCULATE TOTAL FISH BIOMASS (watershed-level means - not design estimates)
rm(list=ls())
load("TMPwsd_speciesLevelBiomass.Rdata")

# Merge with watershed info
shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector_withAunuu.csv")
common.info<-names(wsd)[names(wsd) %in% names(shed.info)]
#Remove DATE, LAT, and LONG
common.info<-c("OBS_YEAR", "REGION", "ISLAND", "SEC_NAME", "SITE", "REEF_ZONE", "DEPTH_BIN")
wsd.village<-merge(x=wsd, y=shed.info, by=common.info, all.x=TRUE)
biomass.shed<-aggregate(wsd.village$TotFish, by=list(wsd.village$Watershed), FUN=mean)
names(biomass.shed)<-c("Watershed", "Biomass")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(biomass.shed, "indexBiomass-AllWatersheds.csv")


##############################################################################
##############################################################################
##############################################################################
# CALCULATE species-level HERBIVORE grazing DIVERSITY
rm(list=ls())
library(gdata)             # needed for drop_levels()
library(vegan)
### First need to create wsd for species-level biomass
## N.b., it's OK to use Calc_Site_Bio for SPECIES (i.e., site-level TOTAL Biomass)
## Applying average grazing rate to site-level (rather than individual-level first before summing across individuals) is the same

setwd("~/Analyses_notGit/socio-ecoVulnerability/input")
# First need to create wsd for families (e.g., )
load("TMPwsd_speciesLevelBiomass.RData")

fishcols<-subset(wsd, select=ABSO:ZEVE)
species<-names(fishcols)
sitecols<-subset(wsd, select=SITEVISITID:DEPTH)
siteinfo<-names(sitecols)

wsd.tmp<-subset(wsd, select=c(SITEVISITID:DEPTH, ABSO:ZEVE))
#wsd.tmp[wsd.tmp==0]<-"NA"
#if I try to force NA's initially, melt won't remove these rows because it cannot be coerced as a logical value (columns are numeric)
# so instead melt first and remove NAs below
wsd.melt<-melt(wsd.tmp, id.vars=siteinfo, na.rm=TRUE)

names(wsd.melt)[(length(wsd.melt)-1):length(wsd.melt)]<-c("SPECIES", "biomass")

# Now remove 0's
na.fish<-wsd.melt$biomass!="0"
wsd.melt<-wsd.melt[na.fish,]


# Merge with fish.tab to get Trophic Group of Each Species
fish.tab<-read.csv("LIST_OF_FISH_SPECIES 20161024.csv")
# Jonatha's index requires max body size (< or > 20cm) and trophic group (corallivore, mixed, or herbivore)
fish.names<-subset(fish.tab, select=c("SPECIES", "SCIENTIFIC_NAME", "TAXONNAME", "TROPHIC"))

wsd.troph<-merge(wsd.melt, fish.names, by="SPECIES")

# Merge with watershed info
shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector_withAunuu.csv")
common.info<-names(wsd.troph)[names(wsd.troph) %in% names(shed.info)]
#Remove DATE, LAT, and LONG
common.info<-c("OBS_YEAR", "REGION", "ISLAND", "SEC_NAME", "SITE", "REEF_ZONE", "DEPTH_BIN")
wsd.village<-merge(x=wsd.troph, y=shed.info, by=common.info, all.x=TRUE)
wsd.village<-subset(wsd.village, select=c(OBS_YEAR:TROPHIC,Watershed))


#wsd.test<-(wsd.village$Watershed=="Vatia" | wsd.village$Watershed=="Faga'alu") # OLD study (only Vatia and Fagaalu)
wsd.study<-wsd.village

wsd.herbs<-subset(wsd.study, TROPHIC=="H")
### IF WE CAN FIND VARIABLE GRAZING RATES PER SPECIES THIS IS WHERE IT CAN BE APPLIED
### wsd.herbs$biomass * species-specific grazing rate and then apply Simpson's diversity to THIS
### Here's we'll assume grazing rate is the same across species (Cinner only used two rates: one for fish and one for urchins)

### Since we only have one grazing rate, just apply Simpson's index to species-secific biomass
cast.herbs<-cast(wsd.herbs, SITE ~ SPECIES, value = "biomass")
herb.dat<-subset(cast.herbs, select=-SITE)

herb.dat[is.na(herb.dat)]<-0

# NEXT just need to aggregate at site level, applying (SIMPSON DIVERSITY FUNCTION) to each site
# function "diversity" takes a dataframe, rows are sites, and columns are species
herb.simp<-diversity(herb.dat, index="simpson")

cast.herbs$SITE<-drop.levels(cast.herbs$SITE)
site.simp<-data.frame(herb.simp, cast.herbs$SITE)

names(site.simp)<-c("SimpsonsD", "SITE")

# MERGE Watershed info
setwd("~/Analyses_notGit/socio-ecoVulnerability/input")
#shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector.csv")
shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector_withAunuu.csv")
Simps.shed<-merge(x=site.simp, y=shed.info, by="SITE")

simp.dat<-aggregate(Simps.shed$SimpsonsD, by=list(Simps.shed$Watershed), FUN=mean)
names(simp.dat)<-c("Watershed", "herbDiversity")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(simp.dat, "indexHerbDiversity-AllWatersheds.csv")


##############################################################################
##############################################################################
##############################################################################
##############################################################################

# Calculate Herbivore rate relative to algal production
# According to Cinner et al, herbivore grazing rates (kg per day) can be calculated as 22% of their body mass 
# According to Cinner et al, algal prodcution estimated as 196 kg/ha/day at 100% algal cover...
# MULTIPLIED by average percent cover of TURF, MA, CCA
# If we had species-specific herbivory rates (including urchins), we could "weight" each species' bioamss by this rate 
# Instead, just scale both metrics (herbivore biomass and mean algal cover) and combine 

rm(list=ls())

library(reshape)  #cast function
setwd("~/Analyses_notGit/socio-ecoVulnerability/input")
### First need to create wsd for species-level biomass
load("TMPwsd_trophicLevelBiomass.RData")



# Merge with watershed info
shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector_withAunuu.csv")
#common.info<-names(wsd.troph)[names(wsd) %in% names(shed.info)]
#Remove DATE, LAT, and LONG
common.info<-c("OBS_YEAR", "REGION", "ISLAND", "SEC_NAME", "SITE", "REEF_ZONE", "DEPTH_BIN", "SITEVISITID")
wsd.village<-merge(x=wsd, y=shed.info, by=common.info, all.x=TRUE)
#wsd.test<-(wsd.village$Watershed=="Vatia" | wsd.village$Watershed=="Faga'alu") # OLD study - only Vatia and Fagaalu
#wsd.study<-wsd.village[wsd.test,]
#wsd.study<-subset(wsd.study, select=c("SITE", "Watershed", "PRIMARY"))

wsd.study<-wsd.village
# SCALE primary biomass density
wsd.study$scalePrimary<-scale(wsd.study$PRIMARY, center=FALSE) # center = FALSE, otherwise introduces negative numbers, keep them all positive


# Average and scale algal covers
#wsd.alg<-subset(wsd, select=c(SITE, MA:TA))
#site.alg<-merge(wsd.study, wsd.alg, by="SITE")
#site.alg<-na.omit(site.alg)
#site.alg$meanAlga<-apply(site.alg[,c("MA", "CCA", "TA")], MARGIN=1, FUN=mean)
#site.alg$scaleAlga<-scale(site.alg$meanAlga, center=FALSE)
wsd.study$meanAlga<-apply(wsd.study[,c("MA", "CCA", "TA")], MARGIN=1, FUN=mean)
wsd.study<-wsd.study[!is.na(wsd.study$meanAlga),]
wsd.study$scaleAlga<-scale(wsd.study$meanAlga, center=FALSE)
# Then combine: grazing MINUS production
wsd.study$HerbAlgIndex<-wsd.study$scalePrimary-wsd.study$scaleAlga

algalRatio<-aggregate(wsd.study$HerbAlgIndex, by=list(wsd.study$Watershed), FUN=mean)
names(algalRatio)<-c("Watershed", "grazingAlgalProdRatio")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(algalRatio, "indexGrazingAlgalProdRatio-AllWatersheds.csv")

##############################################################################
##############################################################################
##############################################################################
# Calculate fish size distribution index - i.e., CV of family level fish size
# CV = mean / SD
# Follow Cinner et al: four families include Acanthurids, Chaetodons, Labrids, Scarids
# STEP 1: for each site, calculate the average sized fish in each of the four families above
# to do this, within each family, multiple size class * relative abundance, and sum across all size classes
# STEP 2: for each site, calculate the average of the four numbers from STEP 1
# STEP 3: for each site, calculate the SD of the four numbers from STEP 1
# STEP 4: for each site, calculate CV = average from STEP 2 divided by SD from step 3
# STEP 5: calculate the average CV of all sites within a watershed


rm(list=ls())
setwd("~/Analyses_notGit/socio-ecoVulnerability/input")
load("TMPwd.Rdata")

# calculate average size of fish in FOUR families
names(wd)
levels(wd$FAMILY)
wd.study<-wd[wd$FAMILY %in% c("Acanthuridae", "Chaetodontidae", "Labridae", "Scaridae"),]
wd.study<-wd.study[wd.study$METHOD=="nSPC",]
wd.study<-wd.study[wd.study$ISLAND=="Tutuila",]
wd.study<-subset(wd.study, select=c(SITE, SITEVISITID, FAMILY, SPECIES, COUNT, SIZE_))

# for each site, calculate relative abundance (i.e., COUNT / TOTAL COUNT) - then use this to weight sizes and then sum across all sizes
wd.agg<-aggregate(wd.study$COUNT, by=list(wd.study$SITE, wd.study$SITEVISITID, wd.study$FAMILY), FUN=sum)
names(wd.agg)<-c("SITE", "SITEVISITID", "FAMILY", "TOTALCOUNT")
wd.merge<-merge(wd.study, wd.agg, by=c("SITE", "SITEVISITID", "FAMILY"))
wd.merge$RELATIVECOUNT<-wd.merge$COUNT/wd.merge$TOTALCOUNT 
wd.merge$WEIGHTEDSIZE<-wd.merge$SIZE*wd.merge$RELATIVECOUNT

# SUM across weightedsizes to get average size of that family, at each site
wd.famsize<-aggregate(wd.merge$WEIGHTEDSIZE, by=list(wd.merge$SITE, wd.merge$SITEVISITID, wd.merge$FAMILY), FUN=sum)
names(wd.famsize)<-c("SITE", "SITEVISITID", "FAMILY", "AVGSIZE")

# calculate MEAN avgsize within each site
wsd.mean<-aggregate(wd.famsize$AVGSIZE, by=list(wd.famsize$SITE, wd.famsize$SITEVISITID), FUN=mean)
names(wsd.mean)<-c("SITE", "SITEVISITID", "MEANSIZE")

# calculate SD of avgsize within each site
wsd.sd<-aggregate(wd.famsize$AVGSIZE, by=list(wd.famsize$SITE, wd.famsize$SITEVISITID), FUN=sd)
names(wsd.sd)<-c("SITE", "SITEVISITID", "SDSIZE")

wsd.cv<-merge(wsd.mean, wsd.sd, by=c("SITE", "SITEVISITID"))
wsd.cv$CV<-wsd.cv$MEANSIZE/wsd.cv$SDSIZE

# MERGE with watershed info
shed.info<-read.csv("SITE_MASTER_2016_TUT_Watershed_Sector_withAunuu.csv")
common.info<-names(wsd.cv)[names(wsd.cv) %in% names(shed.info)]
#Remove DATE, LAT, and LONG
#common.info<-c("OBS_YEAR", "REGION", "ISLAND", "SEC_NAME", "SITE", "REEF_ZONE", "DEPTH_BIN")
wsd.village<-merge(x=wsd.cv, y=shed.info, by=common.info, all.x=TRUE)
wsd.village<-subset(wsd.village, select=c(OBS_YEAR:Climate_susceptibility,Watershed))

# calculate the average CV of all sites within a watershed
cv.village<-aggregate(wsd.village$CV, by=list(wsd.village$Watershed), FUN=mean)
names(cv.village)<-c("Watershed", "MEANCV")
setwd("~/Analyses_notGit/socio-ecoVulnerability/output")
write.csv(cv.village, "indexFishSizeDistr-AllWatersheds.csv")

